{% extends "layout/base.html" %}
{% load static %}

{% block title %}Cadastrar Loja{% endblock title %}

{% block head %}{% endblock head %}

{% block content %}

    <div>
        <div class="pt-[100px] py-5 text-center justify-self-center justify-center items-center">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white md:text-4xl">Cadastro de Informações</h2>
        </div>
        
        
        <form method="POST">
             
            {% csrf_token %} 
            <input hidden type="text" name='owner_name' value="{{ supplier.owner_name }}">
            <input type="hidden" name="email" id="email" value="{{ supplier.email }}">   
            <input type="hidden" name="phone" id="phone" value="{{ supplier.phone }}">      
            <input type="hidden" name="owner_document_number" id="phone" value="{{ supplier.owner_document_number }}">     
            
            {% if errors %}
                <div class="w-full max-w-md py-5 border border-red-500 rounded-lg shadow-md mb-8 mx-auto bg-red-50 text-red-700">
                    <ul>
                        {% for error in errors %}
                            <li class="mx-5">{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>            
            {% endif %}
            <div class="lg:mt-0 lg:col-span-5 lg:flex gap-8 justify-center">    
                        
                <div class="w-full max-w-md py-10 ">
                    <div class="space-y-6 bg-white dark:bg-gray-800 border p-5 border-gray-200 rounded-lg shadow-sm dark:border-gray-700">
                        <div class="form-group error">
                            <label for="postal_code" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Cep</label>
                            <input type="text" 
                                placeholder="00.000-000"
                                name="postal_code" 
                                id="postal_code"  
                                value="{{ supplier.postal_code }}"                       
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block 
                                    w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" autocomplete="postal-code" required>
                        </div>
                        <div>
                            <label for="street" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Logradouro</label>
                            <input type="text" 
                                placeholder="Logradouro"
                                name="street" 
                                id="street" 
                                value="{{ supplier.street }}"   
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block 
                                        w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                        </div>
                        <div class="flex flex-wrap -mx-3 mb-6">
                            <div class="w-full md:w-1/3 px-3 mb-6 md:mb-0">
                                <label for="number" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Número</label>
                                <input type="text" 
                                    placeholder="Número"
                                    name="number" 
                                    id="number" 
                                    value="{{ supplier.number }}"   
                                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block 
                                        w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                            </div>
                            <div class="w-full md:w-2/3 px-3">
                                <label for="complement" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Complemento</label>
                                <input type="text" 
                                    placeholder="Complemento"
                                    name="complement" 
                                    id="complement" 
                                    value="{{ supplier.complement }}"   
                                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block 
                                        w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white">
                            </div>
                        </div>
                        <div>
                            <label for="neighborhood" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Bairro</label>
                            <input type="text" 
                                placeholder="Bairro"
                                name="neighborhood" 
                                id="neighborhood" 
                                value="{{ supplier.neighborhood }}"   
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block 
                                    w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                        </div>
                        <div class="flex flex-wrap -mx-3 mb-6">
                            <div class="w-full md:w-2/3 px-3 mb-6 md:mb-0">
                                <label for="city" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Cidade</label>
                                <input type="text" 
                                    placeholder=""
                                    name="city" 
                                    id="city" 
                                    value="{{ supplier.city }}"   
                                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block 
                                        w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                            </div>
                            <div class="w-full md:w-1/3 px-3">
                                <label for="state" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Estado</label>
                                <input type="text" 
                                    placeholder=""
                                    name="state" 
                                    id="state" 
                                    value="{{ supplier.state }}"   
                                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block 
                                        w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                            </div>
                        </div>   
                    </div>    
                </div>
                <div class="w-full max-w-md py-10">
                    <div class="space-y-6 bg-white dark:bg-gray-800 border p-5 border-gray-200 rounded-lg shadow-sm dark:border-gray-700">
                        <div class="flex flex-wrap -mx-3 mb-6">
                            <div class="w-full md:w-1/2 px-3 md:mb-0">
                                <label for="company_document_number" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">CPF</label>
                                <input type="text" 
                                    placeholder="000.000.000-00"
                                    name="company_document_number" 
                                    id="company_document_number" 
                                    value="{{ supplier.company_document_number }}"   
                                    class="text-center bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 
                                        w-100 p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                            </div>
                            <div class="w-full md:w-1/2 px-3 md:mb-0">
                                <label for="professional_birthdate" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Data de Nascimento</label>
                                <input type="date" 
                                    placeholder="DD/MM/AAAA"
                                    name="professional_birthdate" 
                                    id="professional_birthdate" 
                                    value="{{ supplier.professional_birthdate }}"   
                                    class="text-center bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 
                                        w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                            </div>
                            
                        </div>
                        <div>
                            <label for="company_name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nome Profissional</label>
                            <input type="text" 
                                placeholder="Informe o CPF"
                                name="company_name" 
                                id="company_name" 
                                value="{{ supplier.company_name }}"   
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block 
                                    w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                        </div>
                        <div>
                            <label for="company_phone" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Telefone da Loja (com DDD)</label>
                            <input type="text" 
                                placeholder="(00) 00000-0000"
                                name="company_phone" 
                                id="company_phone"   
                                value="{{ supplier.company_phone }}"                       
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block 
                                    w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                        </div>
                        
                        <div>
                            <label for="company_name_show" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nome Profissional no Aplicativo</label>
                            <input type="text" 
                                placeholder="Nome da Loja no Aplicativo"
                                name="company_name_show" 
                                id="company_name_show" 
                                value="{{ supplier.company_name_show }}"                               
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block 
                                    w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                        </div>
                        <div >
                            <label for="password" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Senha de Acesso</label>
                            <input type="password" 
                                placeholder="********"
                                name="password" 
                                id="password"   
                                value="{{ supplier.password }}"                             
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block 
                                    w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                        </div>
                    </div>
                </div>
            </div>      
            <div class="text-center">                
                <button type="submit" class="text-white bg-purple-600 hover:bg-purple-700 focus:ring-4 focus:ring-purple-200 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-purple-600 dark:hover:bg-purple-700 dark:focus:ring-purple-900">
                    <div class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
                        </svg>
                        <span>&nbsp&nbsp&nbsp&nbsp Continuar </span>
                    </div>
                </button>  
            </div>
        </form>
    </div>
{% endblock content %}

{% block javascript %}
<script src="{% static 'js/jquery.mask.min.js' %}"></script>
<script>
    
    $(document).ready(function() {
        $('#loading').hide();
        $('#loading').css('z-index', "1000");
        $('#postal_code').mask('00.000-000').focus();;
        $('#company_phone').mask('(00) 00000-0000');
        $('#company_document_number').mask('000.000.000-00');

    });

    function isDateValid(dateStr) {
        return !isNaN(new Date(dateStr));
    }
    
    $('#professional_birthdate').on('keyup', function() {
        
        if (!isDateValid($('#professional_birthdate').val())) return false;
        if ($('#professional_birthdate').val().split('-')[0] < 1940 || $('#professional_birthdate').val().split('-')[0] > 2100) return false;
        if ($('#company_document_number').val().length < 14) return false;
        var company_document_number = $('#company_document_number').val().replace(/\D/g,'');
        
        $.ajax({
            url: "{% url 'supplier:get_professional_from_document' %}",
            type: "GET",
            beforeSend: function() {                
                $('#loading').show();                    
                $('input[type=text]').attr('disabled', true);
            },
            data: {
                'company_document_number': company_document_number,
                'professional_birthdate': $('#professional_birthdate').val()
            },
            dataType: "json",
            async: false,
            success: function(data) {  
                $('#company_name').val(data['nome']);
                $('#loading').hide();
                $('input[type=text]').attr('disabled', false);
                $('#company_name_show').focus();
            },
            error: function() {
                alert('Informe um CPF e Data de Nascimento Válido.');
                $('#loading').hide();
                $('input[type=text]').attr('disabled', false);
            }
        });
    });

    $('#company_document_number').on('keyup', function() {
        if ($('#company_document_number').val().length == 14) $('#professional_birthdate').focus();
    });


    $('#postal_code').on('keyup', function() {        
        if ($(this).val().length < 10) return false; 
        var postal_code = $(this).val().replace(/\D/g,'');
        
        $.ajax({
            url: "{% url 'supplier:get_address_from_postal_code' %}",
            type: "GET",
            beforeSend: function() {
                $('#loading').show();
                $('#loading').css('visibility', 'visible');
            },
            data: {
                'postal_code': postal_code
            },
            dataType: "json",
            async: false,
            success: function(data) {    
                if (data['street']) {
                    $('#street').val(data['street']).attr('disabled', true);
                    $('#neighborhood').val(data['neighborhood']).attr('disabled', true);
                    $('#city').val(data['city']).attr('disabled', true);
                    $('#state').val(data['state']).attr('disabled', true);
                    $('#number').focus();
                }else{
                    alert('CEP não encontrado.');
                    $('#street').val('').attr('disabled', false);
                    $('#neighborhood').val('').attr('disabled', false);
                    $('#city').val('').attr('disabled', false);
                    $('#state').val('').attr('disabled', false);
                    $('#postal_code').focus();
                }
                $('#loading').hide();

            },
            error: function() {
                alert('CEP não encontrado.');
                $('#street').val('').attr('disabled', false);
                $('#neighborhood').val('').attr('disabled', false);
                $('#city').val('').attr('disabled', false);
                $('#state').val('').attr('disabled', false);
                $('#postal_code').focus();
                $('#loading').hide();

            }
        });
    });

    

    
</script>
{% endblock javascript %}